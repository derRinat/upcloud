function logerror(e){this.get("env")!=="test"&&console.error(e.stack||e.toString())}var finalhandler=require("finalhandler"),flatten=require("./utils").flatten,Router=require("./router"),methods=require("methods"),middleware=require("./middleware/init"),query=require("./middleware/query"),debug=require("debug")("express:application"),View=require("./view"),http=require("http"),compileETag=require("./utils").compileETag,compileQueryParser=require("./utils").compileQueryParser,compileTrust=require("./utils").compileTrust,deprecate=require("depd")("express"),merge=require("utils-merge"),resolve=require("path").resolve,slice=Array.prototype.slice,app=exports=module.exports={};app.init=function(){this.cache={},this.settings={},this.engines={},this.defaultConfiguration()},app.defaultConfiguration=function(){this.enable("x-powered-by"),this.set("etag","weak");var e=process.env.NODE_ENV||"development";this.set("env",e),this.set("query parser","extended"),this.set("subdomain offset",2),this.set("trust proxy",!1),debug("booting in %s mode",e),this.on("mount",function(e){this.request.__proto__=e.request,this.response.__proto__=e.response,this.engines.__proto__=e.engines,this.settings.__proto__=e.settings}),this.locals=Object.create(null),this.mountpath="/",this.locals.settings=this.settings,this.set("view",View),this.set("views",resolve("views")),this.set("jsonp callback name","callback"),e==="production"&&this.enable("view cache"),Object.defineProperty(this,"router",{get:function(){throw new Error("'app.router' is deprecated!\nPlease see the 3.x to 4.x migration guide for details on how to update your app.")}})},app.lazyrouter=function(){this._router||(this._router=new Router({caseSensitive:this.enabled("case sensitive routing"),strict:this.enabled("strict routing")}),this._router.use(query(this.get("query parser fn"))),this._router.use(middleware.init(this)))},app.handle=function(e,t,n){var r=this._router;n=n||finalhandler(e,t,{env:this.get("env"),onerror:logerror.bind(this)});if(!r){debug("no routes defined on app"),n();return}r.handle(e,t,n)},app.use=function(t){var n=0,r="/";if(typeof t!="function"){var i=t;while(Array.isArray(i)&&i.length!==0)i=i[0];typeof i!="function"&&(n=1,r=t)}var s=flatten(slice.call(arguments,n));if(s.length===0)throw new TypeError("app.use() requires middleware functions");this.lazyrouter();var o=this._router;return s.forEach(function(e){if(!e||!e.handle||!e.set)return o.use(r,e);debug(".use app under %s",r),e.mountpath=r,e.parent=this,o.use(r,function(n,r,i){var s=n.app;e.handle(n,r,function(e){n.__proto__=s.request,r.__proto__=s.response,i(e)})}),e.emit("mount",this)},this),this},app.route=function(e){return this.lazyrouter(),this._router.route(e)},app.engine=function(e,t){if("function"!=typeof t)throw new Error("callback function required");return"."!=e[0]&&(e="."+e),this.engines[e]=t,this},app.param=function(e,t){return this.lazyrouter(),Array.isArray(e)?(e.forEach(function(e){this.param(e,t)},this),this):(this._router.param(e,t),this)},app.set=function(e,t){if(arguments.length===1)return this.settings[e];this.settings[e]=t;switch(e){case"etag":debug("compile etag %s",t),this.set("etag fn",compileETag(t));break;case"query parser":debug("compile query parser %s",t),this.set("query parser fn",compileQueryParser(t));break;case"trust proxy":debug("compile trust proxy %s",t),this.set("trust proxy fn",compileTrust(t))}return this},app.path=function(){return this.parent?this.parent.path()+this.mountpath:""},app.enabled=function(e){return!!this.set(e)},app.disabled=function(e){return!this.set(e)},app.enable=function(e){return this.set(e,!0)},app.disable=function(e){return this.set(e,!1)},methods.forEach(function(e){app[e]=function(t){if("get"==e&&1==arguments.length)return this.set(t);this.lazyrouter();var n=this._router.route(t);return n[e].apply(n,slice.call(arguments,1)),this}}),app.all=function(e){this.lazyrouter();var t=this._router.route(e),n=slice.call(arguments,1);return methods.forEach(function(e){t[e].apply(t,n)}),this},app.del=deprecate.function(app.delete,"app.del: Use app.delete instead"),app.render=function(e,t,n){var r={},i=this.cache,s=this.engines,o;"function"==typeof t&&(n=t,t={}),merge(r,this.locals),t._locals&&merge(r,t._locals),merge(r,t),r.cache=null==r.cache?this.enabled("view cache"):r.cache,r.cache&&(o=i[e]);if(!o){o=new(this.get("view"))(e,{defaultEngine:this.get("view engine"),root:this.get("views"),engines:s});if(!o.path){var u=Array.isArray(o.root)&&o.root.length>1?'directories "'+o.root.slice(0,-1).join('", "')+'" or "'+o.root[o.root.length-1]+'"':'directory "'+o.root+'"',a=new Error('Failed to lookup view "'+e+'" in views '+u);return a.view=o,n(a)}r.cache&&(i[e]=o)}try{o.render(r,n)}catch(a){n(a)}},app.listen=function(){var e=http.createServer(this);return e.listen.apply(e,arguments)};