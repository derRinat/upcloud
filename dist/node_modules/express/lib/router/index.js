function gettype(e){var t=typeof e;return t!=="object"?t:toString.call(e).replace(objectRegExp,"$1")}function mergeParams(e,t){if(typeof t!="object"||!t)return e;var n=mixin({},t);if(0 in e&&0 in t){var r=0,i=0;while(r===i||i in t)r in e&&r++,i in t&&i++;for(r--;r>=0;r--)e[r+i]=e[r],r<i&&delete e[r];return mixin(t,e)}return mixin(n,e)}function restore(e,t){var n=new Array(arguments.length-2),r=new Array(arguments.length-2);for(var i=0;i<n.length;i++)n[i]=arguments[i+2],r[i]=t[n[i]];return function(i){for(var s=0;s<n.length;s++)t[n[s]]=r[s];return e.apply(this,arguments)}}function wrap(e,t){return function(){var r=new Array(arguments.length+1);r[0]=e;for(var i=0,s=arguments.length;i<s;i++)r[i+1]=arguments[i];t.apply(this,r)}}var Route=require("./route"),Layer=require("./layer"),methods=require("methods"),mixin=require("utils-merge"),debug=require("debug")("express:router"),parseUrl=require("parseurl"),utils=require("../utils"),objectRegExp=/^\[object (\S+)\]$/,slice=Array.prototype.slice,toString=Object.prototype.toString,proto=module.exports=function(e){function t(e,n,r){t.handle(e,n,r)}return e=e||{},t.__proto__=proto,t.params={},t._params=[],t.caseSensitive=e.caseSensitive,t.mergeParams=e.mergeParams,t.strict=e.strict,t.stack=[],t};proto.param=function(e,t){if("function"==typeof e){this._params.push(e);return}var n=this._params,r=n.length,i;e[0]===":"&&(e=e.substr(1));for(var s=0;s<r;++s)if(i=n[s](e,t))t=i;if("function"!=typeof t)throw new Error("invalid param() call for "+e+", got "+t);return(this.params[e]=this.params[e]||[]).push(t),this},proto.handle=function(e,t,n){function m(i){var s=i==="route"?null:i,o=p[a++];l&&(e.url=e.url.substr(1),l=!1),f.length!==0&&(e.baseUrl=v,e.url=u+f+e.url.substr(u.length),f="");if(!o){setImmediate(n,s);return}r.match_layer(o,e,t,function(n,i){if(n||i===undefined)return m(s||n);var u=o.route;if(u){if(s)return m(s);var a=e.method,f=u._handles_method(a);!f&&a==="OPTIONS"&&h.push.apply(h,u._options());if(!f&&a!=="HEAD")return m();e.route=u}e.params=r.mergeParams?mergeParams(o.params,d):o.params;var l=o.path;r.process_params(o,c,e,t,function(n){if(n)return m(s||n);if(u)return o.handle_request(e,t,m);g(o,s,l,i)})})}function g(n,r,i,s){var a=s[i.length];if(a&&"/"!==a&&"."!==a)return m(r);i.length!==0&&(debug("trim prefix (%s) from url %s",i,e.url),f=i,e.url=u+e.url.substr(u.length+f.length),!o&&e.url[0]!=="/"&&(e.url="/"+e.url,l=!0),e.baseUrl=v+(f[f.length-1]==="/"?f.substring(0,f.length-1):f)),debug("%s %s : %s",n.name,i,e.originalUrl),r?n.handle_error(r,e,t,m):n.handle_request(e,t,m)}var r=this;debug("dispatching %s %s",e.method,e.url);var i=1+e.url.indexOf("?"),s=i?i-1:e.url.length,o=e.url[0]!=="/"&&1+e.url.substr(0,s).indexOf("://"),u=o?e.url.substr(0,e.url.indexOf("/",2+o)):"",a=0,f="",l=!1,c={},h=[],p=r.stack,d=e.params,v=e.baseUrl||"";n=restore(n,e,"baseUrl","next","params"),e.next=m,e.method==="OPTIONS"&&(n=wrap(n,function(e,n){if(n||h.length===0)return e(n);var r=h.join(",");return t.set("Allow",r).send(r)})),e.baseUrl=v,e.originalUrl=e.originalUrl||e.url,m()},proto.match_layer=function(t,n,r,i){var s=null,o;try{o=parseUrl(n).pathname,t.match(o)||(o=undefined)}catch(u){s=u}i(s,o)},proto.process_params=function(e,t,n,r,i){function d(e){if(e)return i(e);if(u>=o.length)return i();f=0,l=o[u++];if(!l)return i();a=l.name,c=n.params[a],h=s[a],p=t[a];if(c===undefined||!h)return d();if(p&&(p.error||p.match===c))return n.params[a]=p.value,d(p.error);t[a]=p={error:null,match:c,value:c},v()}function v(e){var t=h[f++];p.value=n.params[l.name];if(e){p.error=e,d(e);return}if(!t)return d();try{t(n,r,v,c,l.name)}catch(i){v(i)}}var s=this.params,o=e.keys;if(!o||o.length===0)return i();var u=0,a,f=0,l,c,h,p;d()},proto.use=function(t){var n=0,r="/";if(typeof t!="function"){var i=t;while(Array.isArray(i)&&i.length!==0)i=i[0];typeof i!="function"&&(n=1,r=t)}var s=utils.flatten(slice.call(arguments,n));if(s.length===0)throw new TypeError("Router.use() requires middleware functions");return s.forEach(function(e){if(typeof e!="function")throw new TypeError("Router.use() requires middleware function but got a "+gettype(e));debug("use %s %s",r,e.name||"<anonymous>");var t=new Layer(r,{sensitive:this.caseSensitive,strict:!1,end:!1},e);t.route=undefined,this.stack.push(t)},this),this},proto.route=function(e){var t=new Route(e),n=new Layer(e,{sensitive:this.caseSensitive,strict:this.strict,end:!0},t.dispatch.bind(t));return n.route=t,this.stack.push(n),t},methods.concat("all").forEach(function(e){proto[e]=function(t){var n=this.route(t);return n[e].apply(n,slice.call(arguments,1)),this}});