function sendfile(e,t,n,r){function s(){if(i)return;i=!0;var e=new Error("EISDIR, read");e.code="EISDIR",r(e)}function o(e){if(i)return;i=!0,r(e)}function u(){if(i)return;i=!0,r()}function a(e){if(e)return o(e);if(i)return;setImmediate(function(){if(i)return;i=!0;var e=new Error("Request aborted");e.code="ECONNABORT",r(e)})}var i=!1;t.on("end",u),t.on("error",o),t.on("directory",s),onFinished(e,a),n.headers&&t.on("headers",function(t){var r=n.headers,i=Object.keys(r);for(var s=0;s<i.length;s++){var o=i[s];t.setHeader(o,r[o])}}),t.pipe(e)}var contentDisposition=require("content-disposition"),deprecate=require("depd")("express"),escapeHtml=require("escape-html"),http=require("http"),isAbsolute=require("./utils").isAbsolute,onFinished=require("on-finished"),path=require("path"),merge=require("utils-merge"),sign=require("cookie-signature").sign,normalizeType=require("./utils").normalizeType,normalizeTypes=require("./utils").normalizeTypes,setCharset=require("./utils").setCharset,statusCodes=http.STATUS_CODES,cookie=require("cookie"),send=require("send"),extname=path.extname,mime=send.mime,resolve=path.resolve,vary=require("vary"),res=module.exports={__proto__:http.ServerResponse.prototype};res.status=function(e){return this.statusCode=e,this},res.links=function(e){var t=this.get("Link")||"";return t&&(t+=", "),this.set("Link",t+Object.keys(e).map(function(t){return"<"+e[t]+'>; rel="'+t+'"'}).join(", "))},res.send=function(t){var n=t,r,i,s=this.req,o,u=this.app;arguments.length===2&&(typeof arguments[0]!="number"&&typeof arguments[1]=="number"?(deprecate("res.send(body, status): Use res.status(status).send(body) instead"),this.statusCode=arguments[1]):(deprecate("res.send(status, body): Use res.status(status).send(body) instead"),this.statusCode=arguments[0],n=arguments[1])),typeof n=="number"&&arguments.length===1&&(this.get("Content-Type")||this.type("txt"),deprecate("res.send(status): Use res.sendStatus(status) instead"),this.statusCode=n,n=http.STATUS_CODES[n]);switch(typeof n){case"string":this.get("Content-Type")||this.type("html");break;case"boolean":case"number":case"object":if(n===null)n="";else{if(!Buffer.isBuffer(n))return this.json(n);this.get("Content-Type")||this.type("bin")}}typeof n=="string"&&(r="utf8",o=this.get("Content-Type"),typeof o=="string"&&this.set("Content-Type",setCharset(o,"utf-8"))),n!==undefined&&(Buffer.isBuffer(n)||(n=new Buffer(n,r),r=undefined),i=n.length,this.set("Content-Length",i));var a=s.method==="HEAD";if(i!==undefined&&(a||s.method==="GET")){var f=u.get("etag fn");f&&!this.get("ETag")&&(f=f(n,r),f&&this.set("ETag",f))}s.fresh&&(this.statusCode=304);if(204==this.statusCode||304==this.statusCode)this.removeHeader("Content-Type"),this.removeHeader("Content-Length"),this.removeHeader("Transfer-Encoding"),n="";return a&&this.end(),this.end(n,r),this},res.json=function(t){var n=t;arguments.length===2&&(typeof arguments[1]=="number"?(deprecate("res.json(obj, status): Use res.status(status).json(obj) instead"),this.statusCode=arguments[1]):(deprecate("res.json(status, obj): Use res.status(status).json(obj) instead"),this.statusCode=arguments[0],n=arguments[1]));var r=this.app,i=r.get("json replacer"),s=r.get("json spaces"),o=JSON.stringify(n,i,s);return this.get("Content-Type")||this.set("Content-Type","application/json"),this.send(o)},res.jsonp=function(t){var n=t;arguments.length===2&&(typeof arguments[1]=="number"?(deprecate("res.jsonp(obj, status): Use res.status(status).json(obj) instead"),this.statusCode=arguments[1]):(deprecate("res.jsonp(status, obj): Use res.status(status).jsonp(obj) instead"),this.statusCode=arguments[0],n=arguments[1]));var r=this.app,i=r.get("json replacer"),s=r.get("json spaces"),o=JSON.stringify(n,i,s),u=this.req.query[r.get("jsonp callback name")];return this.get("Content-Type")||(this.set("X-Content-Type-Options","nosniff"),this.set("Content-Type","application/json")),Array.isArray(u)&&(u=u[0]),typeof u=="string"&&u.length!==0&&(this.charset="utf-8",this.set("X-Content-Type-Options","nosniff"),this.set("Content-Type","text/javascript"),u=u.replace(/[^\[\]\w$.]/g,""),o=o.replace(/\u2028/g,"\\u2028").replace(/\u2029/g,"\\u2029"),o="/**/ typeof "+u+" === 'function' && "+u+"("+o+");"),this.send(o)},res.sendStatus=function(t){var n=http.STATUS_CODES[t]||String(t);return this.statusCode=t,this.type("txt"),this.send(n)},res.sendFile=function(t,n,r){var i=this.req,s=this,o=i.next;if(!t)throw new TypeError("path argument is required to res.sendFile");typeof n=="function"&&(r=n,n={}),n=n||{};if(!n.root&&!isAbsolute(t))throw new TypeError("path must be absolute or specify root to res.sendFile");var u=encodeURI(t),a=send(i,u,n);sendfile(s,a,n,function(e){if(r)return r(e);if(e&&e.code==="EISDIR")return o();e&&e.code!=="ECONNABORT"&&o(e)})},res.sendfile=function(e,t,n){var r=this.req,i=this,s=r.next;typeof t=="function"&&(n=t,t={}),t=t||{};var o=send(r,e,t);sendfile(i,o,t,function(e){if(n)return n(e);if(e&&e.code==="EISDIR")return s();e&&e.code!=="ECONNABORT"&&s(e)})},res.sendfile=deprecate.function(res.sendfile,"res.sendfile: Use res.sendFile instead"),res.download=function(t,n,r){typeof n=="function"&&(r=n,n=null),n=n||t;var i={"Content-Disposition":contentDisposition(n)},s=resolve(t);return this.sendFile(s,{headers:i},r)},res.contentType=res.type=function(e){return this.set("Content-Type",~e.indexOf("/")?e:mime.lookup(e))},res.format=function(e){var t=this.req,n=t.next,r=e.default;r&&delete e.default;var i=Object.keys(e),s=t.accepts(i);this.vary("Accept");if(s)this.set("Content-Type",normalizeType(s).value),e[s](t,this,n);else if(r)r();else{var o=new Error("Not Acceptable");o.status=406,o.types=normalizeTypes(i).map(function(e){return e.value}),n(o)}return this},res.attachment=function(t){return t&&this.type(extname(t)),this.set("Content-Disposition",contentDisposition(t)),this},res.set=res.header=function(t,n){if(arguments.length===2){Array.isArray(n)?n=n.map(String):n=String(n);if("content-type"==t.toLowerCase()&&!/;\s*charset\s*=/.test(n)){var r=mime.charsets.lookup(n.split(";")[0]);r&&(n+="; charset="+r.toLowerCase())}this.setHeader(t,n)}else for(var i in t)this.set(i,t[i]);return this},res.get=function(e){return this.getHeader(e)},res.clearCookie=function(e,t){var n={expires:new Date(1),path:"/"};return this.cookie(e,"",t?merge(n,t):n)},res.cookie=function(e,t,n){n=merge({},n);var r=this.req.secret,i=n.signed;if(i&&!r)throw new Error('cookieParser("secret") required for signed cookies');"number"==typeof t&&(t=t.toString()),"object"==typeof t&&(t="j:"+JSON.stringify(t)),i&&(t="s:"+sign(t,r)),"maxAge"in n&&(n.expires=new Date(Date.now()+n.maxAge),n.maxAge/=1e3),null==n.path&&(n.path="/");var s=cookie.serialize(e,String(t),n),o=this.get("Set-Cookie");return o&&(Array.isArray(o)?s=o.concat(s):s=[o,s]),this.set("Set-Cookie",s),this},res.location=function(e){var t=this.req;return"back"==e&&(e=t.get("Referrer")||"/"),this.set("Location",e),this},res.redirect=function(t){var n=t,r,i=302;arguments.length===2&&(typeof arguments[0]=="number"?(i=arguments[0],n=arguments[1]):(deprecate("res.redirect(url, status): Use res.redirect(status, url) instead"),i=arguments[1])),this.location(n),n=this.get("Location"),this.format({text:function(){r=statusCodes[i]+". Redirecting to "+encodeURI(n)},html:function(){var e=escapeHtml(n);r="<p>"+statusCodes[i]+'. Redirecting to <a href="'+e+'">'+e+"</a></p>"},"default":function(){r=""}}),this.statusCode=i,this.set("Content-Length",Buffer.byteLength(r)),this.req.method==="HEAD"&&this.end(),this.end(r)},res.vary=function(e){return!e||Array.isArray(e)&&!e.length?(deprecate("res.vary(): Provide a field name"),this):(vary(this,e),this)},res.render=function(e,t,n){t=t||{};var r=this,i=this.req,s=i.app;"function"==typeof t&&(n=t,t={}),t._locals=r.locals,n=n||function(e,t){if(e)return i.next(e);r.send(t)},s.render(e,t,n)};