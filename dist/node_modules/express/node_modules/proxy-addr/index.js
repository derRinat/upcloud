/*!
 * proxy-addr
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */

function alladdrs(e,t){var n=forwarded(e);if(!t)return n;typeof t!="function"&&(t=compile(t));for(var r=0;r<n.length-1;r++){if(t(n[r],r))continue;n.length=r+1}return n}function compile(e){if(!e)throw new TypeError("argument is required");var t=typeof e=="string"?[e]:e;if(!Array.isArray(t))throw new TypeError("unsupported trust argument");for(var n=0;n<t.length;n++){e=t[n];if(!ipranges.hasOwnProperty(e))continue;e=ipranges[e],t.splice.apply(t,[n,1].concat(e)),n+=e.length-1}return compileTrust(compileRangeSubnets(t))}function compileRangeSubnets(e){var t=new Array(e.length);for(var n=0;n<e.length;n++)t[n]=parseipNotation(e[n]);return t}function compileTrust(e){var t=e.length;return t===0?trustNone:t===1?trustSingle(e[0]):trustMulti(e)}function parseipNotation(e){var t,n,r,i=e.lastIndexOf("/"),s;t=i!==-1?e.substring(0,i):e;if(!isip(t))throw new TypeError("invalid IP address: "+t);t=parseip(t),n=t.kind(),r=n==="ipv6"?128:32,s=i!==-1?e.substring(i+1,e.length):r,typeof s!="number"&&(s=digitre.test(s)?parseInt(s,10):isip(s)?parseNetmask(s):0),t.kind()==="ipv6"&&t.isIPv4MappedAddress()&&(t=t.toIPv4Address(),s=s<=r?s-96:s);if(s<=0||s>r)throw new TypeError("invalid range on address: "+e);return[t,s]}function parseNetmask(e){var t=parseip(e),n,r;switch(t.kind()){case"ipv4":n=t.octets,r=8;break;case"ipv6":n=t.parts,r=16}var i=Math.pow(2,r)-1,s,o=0;for(var u=0;u<n.length;u++){s=n[u]&i;if(s===i){o+=r;continue}while(s)s=s<<1&i,o+=1;break}return o}function proxyaddr(e,t){if(!e)throw new TypeError("req argument is required");if(!t)throw new TypeError("trust argument is required");var n=alladdrs(e,t),r=n[n.length-1];return r}function trustNone(){return!1}function trustMulti(e){return function(n){if(!isip(n))return!1;var r=parseip(n),i,s=r.kind(),o,u,a,f,l;for(var c=0;c<e.length;c++){o=e[c],u=o[0],a=u.kind(),f=o[1],l=r;if(s!==a){if(s!=="ipv6"||a!=="ipv4"||!r.isIPv4MappedAddress())continue;i=i||r.toIPv4Address(),l=i}if(l.match(u,f))return!0}return!1}}function trustSingle(e){var t=e[0],n=t.kind(),r=n==="ipv4",i=e[1];return function(s){if(!isip(s))return!1;var o=parseip(s),u=o.kind();return u===n?o.match(t,i):r&&u==="ipv6"&&o.isIPv4MappedAddress()?o.toIPv4Address().match(t,i):!1}}module.exports=proxyaddr,module.exports.all=alladdrs,module.exports.compile=compile;var forwarded=require("forwarded"),ipaddr=require("ipaddr.js"),digitre=/^[0-9]+$/,isip=ipaddr.isValid,parseip=ipaddr.parse,ipranges={linklocal:["169.254.0.0/16","fe80::/10"],loopback:["127.0.0.1/8","::1/128"],uniquelocal:["10.0.0.0/8","172.16.0.0/12","192.168.0.0/16","fc00::/7"]};