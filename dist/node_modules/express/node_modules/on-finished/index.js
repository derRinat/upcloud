/*!
 * on-finished
 * Copyright(c) 2013 Jonathan Ong
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */

function onFinished(e,t){return isFinished(e)!==!1?(defer(t),e):(attachListener(e,t),e)}function isFinished(e){var t=e.socket;return typeof e.finished=="boolean"?Boolean(e.finished||t&&!t.writable):typeof e.complete=="boolean"?Boolean(!t||e.complete||!t.readable):undefined}function attachFinishedListener(e,t){function s(e){n.cancel(),r.cancel(),i=!0,t(e)}function o(t){e.removeListener("socket",o);if(i)return;if(n!==r)return;r=first([[t,"error","close"]],s)}var n,r,i=!1;n=r=first([[e,"end","finish"]],s);if(e.socket){o(e.socket);return}e.on("socket",o),e.socket===undefined&&patchAssignSocket(e,o)}function attachListener(e,t){var n=e.__onFinished;if(!n||!n.queue)n=e.__onFinished=createListener(e),attachFinishedListener(e,n);n.queue.push(t)}function createListener(e){function t(n){e.__onFinished===t&&(e.__onFinished=null);if(!t.queue)return;var r=t.queue;t.queue=null;for(var i=0;i<r.length;i++)r[i](n)}return t.queue=[],t}function patchAssignSocket(e,t){var n=e.assignSocket;if(typeof n!="function")return;e.assignSocket=function(r){n.call(this,r),t(r)}}module.exports=onFinished,module.exports.isFinished=isFinished;var first=require("ee-first"),defer=typeof setImmediate=="function"?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))};