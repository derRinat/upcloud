/*!
 * finalhandler
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */

function finalhandler(e,t,n){n=n||{};var r=n.env||process.env.NODE_ENV||"development",i=n.onerror;return function(n){var s;if(!n&&t._header){debug("cannot 404 after headers sent");return}if(n){if(!t.statusCode||t.statusCode<400)t.statusCode=500;n.status&&(t.statusCode=n.status);var s=r==="production"?http.STATUS_CODES[t.statusCode]:n.stack||n.toString();s=escapeHtml(s).replace(/\n/g,"<br>").replace(/  /g," &nbsp;")+"\n"}else t.statusCode=404,s="Cannot "+escapeHtml(e.method)+" "+escapeHtml(e.originalUrl||e.url)+"\n";debug("default %s",t.statusCode),n&&i&&defer(i,n,e,t);if(t._header)return e.socket.destroy();send(e,t,t.statusCode,s)}}function send(e,t,n,r){function i(){t.statusCode=n,t.setHeader("X-Content-Type-Options","nosniff"),t.setHeader("Content-Type","text/html; charset=utf-8"),t.setHeader("Content-Length",Buffer.byteLength(r,"utf8"));if(e.method==="HEAD"){t.end();return}t.end(r,"utf8")}if(isFinished(e)){i();return}unpipe(e),onFinished(e,i),e.resume()}function unpipe(e){if(typeof e.unpipe=="function"){e.unpipe();return}var t,n=e.listeners("close");for(var r=0;r<n.length;r++){t=n[r];if(t.name!=="cleanup"&&t.name!=="onclose")continue;t.call(e)}}var debug=require("debug")("finalhandler"),escapeHtml=require("escape-html"),http=require("http"),onFinished=require("on-finished"),defer=typeof setImmediate=="function"?setImmediate:function(e){process.nextTick(e.bind.apply(e,arguments))},isFinished=onFinished.isFinished;module.exports=finalhandler;