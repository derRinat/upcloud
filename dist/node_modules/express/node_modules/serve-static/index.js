/*!
 * serve-static
 * Copyright(c) 2010 Sencha Inc.
 * Copyright(c) 2011 TJ Holowaychuk
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */

var escapeHtml=require("escape-html"),merge=require("utils-merge"),parseurl=require("parseurl"),resolve=require("path").resolve,send=require("send"),url=require("url");exports=module.exports=function(t,n){if(!t)throw new TypeError("root path required");if(typeof t!="string")throw new TypeError("root path must be a string");n=merge({},n),t=resolve(t);var r=n.redirect!==!1,i=n.setHeaders;delete n.setHeaders;if(i&&typeof i!="function")throw new TypeError("option setHeaders must be function");return n.maxage=n.maxage||n.maxAge||0,n.root=t,function(t,s,o){if(t.method!=="GET"&&t.method!=="HEAD")return o();var u=merge({},n),a=parseurl.original(t),f=parseurl(t).pathname,l=a.pathname[a.pathname.length-1]==="/";f==="/"&&!l&&(f="");var c=send(t,f,u);r?c.on("directory",function(){if(l)return o();a.pathname+="/";var t=url.format(a);s.statusCode=303,s.setHeader("Content-Type","text/html; charset=utf-8"),s.setHeader("Location",t),s.end('Redirecting to <a href="'+escapeHtml(t)+'">'+escapeHtml(t)+"</a>\n")}):c.on("directory",o),i&&c.on("headers",i),c.on("error",function(t){o(t.status===404?null:t)}),c.pipe(s)}},exports.mime=send.mime;