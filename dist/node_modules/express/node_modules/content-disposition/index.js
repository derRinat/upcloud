/*!
 * content-disposition
 * Copyright(c) 2014 Douglas Christopher Wilson
 * MIT Licensed
 */

function contentDisposition(e,t){var n=t||{},r=n.type||"attachment",i=createparams(e,n.fallback);return format(new ContentDisposition(r,i))}function createparams(e,t){if(e===undefined)return;var n={};if(typeof e!="string")throw new TypeError("filename must be a string");t===undefined&&(t=!0);if(typeof t!="string"&&typeof t!="boolean")throw new TypeError("fallback must be a string or boolean");if(typeof t=="string"&&nonLatin1RegExp.test(t))throw new TypeError("fallback must be ISO-8859-1 string");var r=basename(e),i=textRegExp.test(r),s=typeof t!="string"?t&&getlatin1(r):basename(t),o=typeof s=="string"&&s!==r;if(o||!i||hexEscapeRegExp.test(r))n["filename*"]=r;if(i||o)n.filename=o?s:r;return n}function format(e){var t=e.parameters,n=e.type;if(!n||typeof n!="string"||!tokenRegExp.test(n))throw new TypeError("invalid type");var r=String(n).toLowerCase();if(t&&typeof t=="object"){var i,s=Object.keys(t).sort();for(var o=0;o<s.length;o++){i=s[o];var u=i.substr(-1)==="*"?ustring(t[i]):qstring(t[i]);r+="; "+i+"="+u}}return r}function decodefield(e){var t=extValueRegExp.exec(e);if(!t)throw new TypeError("invalid extended field value");var n=t[1].toLowerCase(),r=t[2],i,s=r.replace(hexEscapeReplaceRegExp,pdecode);switch(n){case"iso-8859-1":i=getlatin1(s);break;case"utf-8":i=(new Buffer(s,"binary")).toString("utf8");break;default:throw new TypeError("unsupported charset in extended field")}return i}function getlatin1(e){return String(e).replace(nonLatin1RegExp,"?")}function parse(e){if(!e||typeof e!="string")throw new TypeError("argument string is required");var t=dispositionTypeRegExp.exec(e);if(!t)throw new TypeError("invalid type format");var n=t[0].length,r=t[1].toLowerCase(),i,s=[],o={},u;n=paramRegExp.lastIndex=t[0].substr(-1)===";"?n-1:n;while(t=paramRegExp.exec(e)){if(t.index!==n)throw new TypeError("invalid parameter format");n+=t[0].length,i=t[1].toLowerCase(),u=t[2];if(s.indexOf(i)!==-1)throw new TypeError("invalid duplicate parameter");s.push(i);if(i.indexOf("*")+1===i.length){i=i.slice(0,-1),u=decodefield(u),o[i]=u;continue}if(typeof o[i]=="string")continue;u[0]==='"'&&(u=u.substr(1,u.length-2).replace(qescRegExp,"$1")),o[i]=u}if(n!==-1&&n!==e.length)throw new TypeError("invalid parameter format");return new ContentDisposition(r,o)}function pdecode(e,t){return String.fromCharCode(parseInt(t,16))}function pencode(e){var t=String(e).charCodeAt(0).toString(16).toUpperCase();return t.length===1?"%0"+t:"%"+t}function qstring(e){var t=String(e);return'"'+t.replace(quoteRegExp,"\\$1")+'"'}function ustring(e){var t=String(e),n=encodeURIComponent(t).replace(encodeUriAttrCharRegExp,pencode);return"UTF-8''"+n}function ContentDisposition(e,t){this.type=e,this.parameters=t}module.exports=contentDisposition,module.exports.parse=parse;var basename=require("path").basename,encodeUriAttrCharRegExp=/[\x00-\x20"'\(\)*,\/:;<=>?@\[\\\]\{\}\x7f]/g,hexEscapeRegExp=/%[0-9A-Fa-f]{2}/,hexEscapeReplaceRegExp=/%([0-9A-Fa-f]{2})/g,nonLatin1RegExp=/[^\x20-\x7e\xa0-\xff]/g,qescRegExp=/\\([\u0000-\u007f])/g,quoteRegExp=/([\\"])/g,paramRegExp=/; *([!#$%&'\*\+\-\.0-9A-Z\^_`a-z\|~]+) *= *("(?:[ !\x23-\x5b\x5d-\x7e\x80-\xff]|\\[\x20-\x7e])*"|[!#$%&'\*\+\-\.0-9A-Z\^_`a-z\|~]+) */g,textRegExp=/^[\x20-\x7e\x80-\xff]+$/,tokenRegExp=/^[!#$%&'\*\+\-\.0-9A-Z\^_`a-z\|~]+$/,extValueRegExp=/^([A-Za-z0-9!#$%&+\-^_`{}~]+)'(?:[A-Za-z]{2,3}(?:-[A-Za-z]{3}){0,3}|[A-Za-z]{4,8}|)'((?:%[0-9A-Fa-f]{2}|[A-Za-z0-9!#$&+\-\.^_`|~])+)$/,dispositionTypeRegExp=/^([!#$%&'\*\+\-\.0-9A-Z\^_`a-z\|~]+) *(?:$|;)/;