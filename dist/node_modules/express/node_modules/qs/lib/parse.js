var Utils=require("./utils"),internals={delimiter:"&",depth:5,arrayLimit:20,parameterLimit:1e3};internals.parseValues=function(e,t){var n={},r=e.split(t.delimiter,t.parameterLimit===Infinity?undefined:t.parameterLimit);for(var i=0,s=r.length;i<s;++i){var o=r[i],u=o.indexOf("]=")===-1?o.indexOf("="):o.indexOf("]=")+1;if(u===-1)n[Utils.decode(o)]="";else{var a=Utils.decode(o.slice(0,u)),f=Utils.decode(o.slice(u+1));n.hasOwnProperty(a)?n[a]=[].concat(n[a]).concat(f):n[a]=f}}return n},internals.parseObject=function(e,t,n){if(!e.length)return t;var r=e.shift(),i={};if(r==="[]")i=[],i=i.concat(internals.parseObject(e,t,n));else{var s=r[0]==="["&&r[r.length-1]==="]"?r.slice(1,r.length-1):r,o=parseInt(s,10),u=""+o;!isNaN(o)&&r!==s&&u===s&&o<=n.arrayLimit?(i=[],i[o]=internals.parseObject(e,t,n)):i[s]=internals.parseObject(e,t,n)}return i},internals.parseKeys=function(e,t,n){if(!e)return;var r=/^([^\[\]]*)/,i=/(\[[^\[\]]*\])/g,s=r.exec(e);if(Object.prototype.hasOwnProperty(s[1]))return;var o=[];s[1]&&o.push(s[1]);var u=0;while((s=i.exec(e))!==null&&u<n.depth)++u,Object.prototype.hasOwnProperty(s[1].replace(/\[|\]/g,""))||o.push(s[1]);return s&&o.push("["+e.slice(s.index)+"]"),internals.parseObject(o,t,n)},module.exports=function(e,t){if(e===""||e===null||typeof e=="undefined")return{};t=t||{},t.delimiter=typeof t.delimiter=="string"||Utils.isRegExp(t.delimiter)?t.delimiter:internals.delimiter,t.depth=typeof t.depth=="number"?t.depth:internals.depth,t.arrayLimit=typeof t.arrayLimit=="number"?t.arrayLimit:internals.arrayLimit,t.parameterLimit=typeof t.parameterLimit=="number"?t.parameterLimit:internals.parameterLimit;var n=typeof e=="string"?internals.parseValues(e,t):e,r={},i=Object.keys(n);for(var s=0,o=i.length;s<o;++s){var u=i[s],a=internals.parseKeys(u,n[u],t);r=Utils.merge(r,a)}return Utils.compact(r)};