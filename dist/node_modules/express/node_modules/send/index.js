function send(e,t,n){return new SendStream(e,t,n)}function SendStream(e,t,n){var r=this;n=n||{},this.req=e,this.path=t,this.options=n,this._etag=n.etag!==undefined?Boolean(n.etag):!0,this._dotfiles=n.dotfiles!==undefined?n.dotfiles:"ignore";if(["allow","deny","ignore"].indexOf(this._dotfiles)===-1)throw new TypeError('dotfiles option must be "allow", "deny", or "ignore"');this._hidden=Boolean(n.hidden),"hidden"in n&&deprecate("hidden: use dotfiles: '"+(this._hidden?"allow":"ignore")+"' instead"),"dotfiles"in n||(this._dotfiles=undefined),this._extensions=n.extensions!==undefined?normalizeList(n.extensions):[],this._index=n.index!==undefined?normalizeList(n.index):["index.html"],this._lastModified=n.lastModified!==undefined?Boolean(n.lastModified):!0,this._maxage=n.maxAge||n.maxage,this._maxage=typeof this._maxage=="string"?ms(this._maxage):Number(this._maxage),this._maxage=isNaN(this._maxage)?0:Math.min(Math.max(0,this._maxage),maxMaxAge),this._root=n.root?resolve(n.root):null,!this._root&&n.from&&this.from(n.from)}function containsDotFile(e){for(var t=0;t<e.length;t++)if(e[t][0]===".")return!0;return!1}function decode(e){try{return decodeURIComponent(e)}catch(t){return-1}}function normalizeList(e){return[].concat(e||[])}var debug=require("debug")("send"),deprecate=require("depd")("send"),destroy=require("destroy"),escapeHtml=require("escape-html"),parseRange=require("range-parser"),Stream=require("stream"),mime=require("mime"),fresh=require("fresh"),path=require("path"),http=require("http"),fs=require("fs"),normalize=path.normalize,join=path.join,etag=require("etag"),EventEmitter=require("events").EventEmitter,ms=require("ms"),onFinished=require("on-finished"),extname=path.extname,maxMaxAge=31536e6,resolve=path.resolve,sep=path.sep,toString=Object.prototype.toString,upPathRegexp=/(?:^|[\\\/])\.\.(?:[\\\/]|$)/;exports=module.exports=send,exports.mime=mime;var listenerCount=EventEmitter.listenerCount||function(e,t){return e.listeners(t).length};SendStream.prototype.__proto__=Stream.prototype,SendStream.prototype.etag=deprecate.function(function(t){return t=Boolean(t),debug("etag %s",t),this._etag=t,this},"send.etag: pass etag as option"),SendStream.prototype.hidden=deprecate.function(function(t){return t=Boolean(t),debug("hidden %s",t),this._hidden=t,this._dotfiles=undefined,this},"send.hidden: use dotfiles option"),SendStream.prototype.index=deprecate.function(function e(t){var e=t?normalizeList(t):[];return debug("index %o",t),this._index=e,this},"send.index: pass index as option"),SendStream.prototype.root=function(e){return e=String(e),this._root=resolve(e),this},SendStream.prototype.from=deprecate.function(SendStream.prototype.root,"send.from: pass root as option"),SendStream.prototype.root=deprecate.function(SendStream.prototype.root,"send.root: pass root as option"),SendStream.prototype.maxage=deprecate.function(function(t){return t=typeof t=="string"?ms(t):Number(t),isNaN(t)&&(t=0),Infinity==t&&(t=31536e6),debug("max-age %d",t),this._maxage=t,this},"send.maxage: pass maxAge as option"),SendStream.prototype.error=function(e,t){var n=this.res,r=http.STATUS_CODES[e];t=t||new Error(r),t.status=e;if(listenerCount(this,"error")!==0)return this.emit("error",t);n._headers=undefined,n.statusCode=t.status,n.end(r)},SendStream.prototype.hasTrailingSlash=function(){return"/"==this.path[this.path.length-1]},SendStream.prototype.isConditionalGET=function(){return this.req.headers["if-none-match"]||this.req.headers["if-modified-since"]},SendStream.prototype.removeContentHeaderFields=function(){var e=this.res;Object.keys(e._headers).forEach(function(t){0==t.indexOf("content")&&e.removeHeader(t)})},SendStream.prototype.notModified=function(){var e=this.res;debug("not modified"),this.removeContentHeaderFields(),e.statusCode=304,e.end()},SendStream.prototype.headersAlreadySent=function(){var t=new Error("Can't set headers after they are sent.");debug("headers already sent"),this.error(500,t)},SendStream.prototype.isCachable=function(){var e=this.res;return e.statusCode>=200&&e.statusCode<300||304==e.statusCode},SendStream.prototype.onStatError=function(e){var t=["ENOENT","ENAMETOOLONG","ENOTDIR"];if(~t.indexOf(e.code))return this.error(404,e);this.error(500,e)},SendStream.prototype.isFresh=function(){return fresh(this.req.headers,this.res._headers)},SendStream.prototype.isRangeFresh=function(){var t=this.req.headers["if-range"];return t?~t.indexOf('"')?~t.indexOf(this.res._headers.etag):Date.parse(this.res._headers["last-modified"])<=Date.parse(t):!0},SendStream.prototype.redirect=function(e){if(listenerCount(this,"directory")!==0)return this.emit("directory");if(this.hasTrailingSlash())return this.error(403);var t=this.res;e+="/",t.statusCode=301,t.setHeader("Content-Type","text/html; charset=utf-8"),t.setHeader("Location",e),t.end('Redirecting to <a href="'+escapeHtml(e)+'">'+escapeHtml(e)+"</a>\n")},SendStream.prototype.pipe=function(e){var t=this,n=arguments,r=this._root;this.res=e;var i=decode(this.path);if(i===-1)return this.error(400);if(~i.indexOf("\0"))return this.error(400);var s;if(r!==null){i=normalize(join(r,i)),r=normalize(r+sep);if((i+sep).substr(0,r.length)!==r)return debug('malicious path "%s"',i),this.error(403);s=i.substr(r.length).split(sep)}else{if(upPathRegexp.test(i))return debug('malicious path "%s"',i),this.error(403);s=normalize(i).split(sep),i=resolve(i)}if(containsDotFile(s)){var o=this._dotfiles;o===undefined&&(o=s[s.length-1][0]==="."?this._hidden?"allow":"ignore":"allow"),debug('%s dotfile "%s"',o,i);switch(o){case"allow":break;case"deny":return this.error(403);case"ignore":default:return this.error(404)}}return this._index.length&&this.path[this.path.length-1]==="/"?(this.sendIndex(i),e):(this.sendFile(i),e)},SendStream.prototype.send=function(e,t){var n=this.options,r=t.size,i=this.res,s=this.req,o=s.headers.range,u=n.start||0;if(i._header)return this.headersAlreadySent();debug('pipe "%s"',e),this.setHeader(e,t),this.type(e);if(this.isConditionalGET()&&this.isCachable()&&this.isFresh())return this.notModified();r=Math.max(0,r-u);if(n.end!==undefined){var a=n.end-u+1;r>a&&(r=a)}if(o){o=parseRange(r,o),this.isRangeFresh()||(debug("range stale"),o=-2);if(-1==o)return debug("range unsatisfiable"),i.setHeader("Content-Range","bytes */"+t.size),this.error(416);-2!=o&&o.length===1&&(debug("range %j",o),n.start=u+o[0].start,n.end=u+o[0].end,i.statusCode=206,i.setHeader("Content-Range","bytes "+o[0].start+"-"+o[0].end+"/"+r),r=n.end-n.start+1)}i.setHeader("Content-Length",r);if("HEAD"==s.method)return i.end();this.stream(e,n)},SendStream.prototype.sendFile=function(t){function i(e){if(r._extensions.length<=n)return e?r.onStatError(e):r.error(404);var s=t+"."+r._extensions[n++];debug('stat "%s"',s),fs.stat(s,function(e,t){if(e)return i(e);if(t.isDirectory())return i();r.emit("file",s,t),r.send(s,t)})}var n=0,r=this;debug('stat "%s"',t),fs.stat(t,function(n,s){if(n&&n.code==="ENOENT"&&!extname(t)&&t[t.length-1]!==sep)return i(n);if(n)return r.onStatError(n);if(s.isDirectory())return r.redirect(r.path);r.emit("file",t,s),r.send(t,s)})},SendStream.prototype.sendIndex=function(t){function i(e){if(++n>=r._index.length)return e?r.onStatError(e):r.error(404);var s=join(t,r._index[n]);debug('stat "%s"',s),fs.stat(s,function(e,t){if(e)return i(e);if(t.isDirectory())return i();r.emit("file",s,t),r.send(s,t)})}var n=-1,r=this;i()},SendStream.prototype.stream=function(e,t){var n=!1,r=this,i=this.res,s=this.req,o=fs.createReadStream(e,t);this.emit("stream",o),o.pipe(i),onFinished(i,function(){n=!0,destroy(o)}),o.on("error",function(t){if(n)return;n=!0,destroy(o),r.onStatError(t)}),o.on("end",function(){r.emit("end")})},SendStream.prototype.type=function(e){var t=this.res;if(t.getHeader("Content-Type"))return;var n=mime.lookup(e),r=mime.charsets.lookup(n);debug("content-type %s",n),t.setHeader("Content-Type",n+(r?"; charset="+r:""))},SendStream.prototype.setHeader=function(t,n){var r=this.res;this.emit("headers",r,t,n),r.getHeader("Accept-Ranges")||r.setHeader("Accept-Ranges","bytes"),r.getHeader("Date")||r.setHeader("Date",(new Date).toUTCString()),r.getHeader("Cache-Control")||r.setHeader("Cache-Control","public, max-age="+Math.floor(this._maxage/1e3));if(this._lastModified&&!r.getHeader("Last-Modified")){var i=n.mtime.toUTCString();debug("modified %s",i),r.setHeader("Last-Modified",i)}if(this._etag&&!r.getHeader("ETag")){var s=etag(n);debug("etag %s",s),r.setHeader("ETag",s)}};